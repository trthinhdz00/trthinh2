<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Exercise 3 – 33 câu trắc nghiệm</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
:root{--accent:#6366f1}
body{background:linear-gradient(135deg,#f8fafc,#fff);font-family:Inter,system-ui,-apple-system,Segoe UI}
.card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(15,23,42,.08)}
.tab{padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
.tab-active{background:var(--accent);color:#fff}
.btn{padding:.6rem 1rem;border-radius:.75rem}
.btn-ghost{background:#f3f4f6}
.btn-primary{background:var(--accent);color:#fff}
.choice{transition:transform .12s,box-shadow .12s,background .12s,border-color .12s}
.choice:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(99,102,241,.14)}
.choice.selected{border-color:#6366f1;background:linear-gradient(180deg,#ffffff,#eef2ff)}
.choice.correct{border-color:#16a34a;background:linear-gradient(180deg,#ffffff,#dcfce7)}
.choice.wrong{border-color:#ef4444;background:linear-gradient(180deg,#ffffff,#fee2e2)}
.badge{font-size:.72rem;padding:2px 8px;border-radius:999px}
.progress-wrap{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden}
.progress{height:100%;background:var(--accent);width:0%}
.sticky-submit{position:sticky;bottom:-8px;background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.96));padding-top:8px}
.fade{animation:fade .25s ease-out both}@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.small{font-size:.8rem;color:#6b7280}
</style>
</head>
<body class="min-h-screen flex items-start justify-center py-6">
<div class="w-full max-w-5xl px-3">
  <header class="mb-4 text-center">
    <h1 class="text-2xl font-extrabold">Exercise 3 – 33 câu trắc nghiệm</h1>
    <p class="text-sm text-gray-500">Điền tên, làm bài → bấm <b>Nộp bài</b>. Bấm <b>Làm lại</b> sẽ xáo thứ tự câu & đáp án.</p>
  </header>

  <div class="card fade">
    <!-- Tabs -->
    <div class="flex gap-2 items-center">
      <div id="tabQuiz" class="tab tab-active">Làm bài</div>
      <div id="tabRank" class="tab">Bảng xếp hạng</div>
      <div id="tabAdmin" class="tab">Admin</div>
      <div class="ml-auto flex items-center gap-2">
        <div class="hidden sm:flex items-center gap-2 text-sm text-gray-600">
          <span>Thời gian:</span><span id="clock" class="font-semibold text-gray-800">20:00</span>
        </div>
        <button id="btnResetAll" class="btn btn-ghost">Làm lại</button>
        <button id="btnSubmitTop" class="btn btn-primary">Nộp bài</button>
      </div>
    </div>

    <div class="progress-wrap my-2"><div id="progress" class="progress"></div></div>

    <!-- Name -->
    <div class="mb-3 flex gap-2 items-center">
      <label class="text-sm text-gray-600">Tên của bạn:</label>
      <input id="inpName" class="px-3 py-2 border rounded w-56" placeholder="VD: Nguyen A">
      <span id="nameWarn" class="small ml-2 hidden text-rose-600">* Tên bắt buộc & không trùng BXH</span>
    </div>

    <!-- QUIZ AREA -->
    <div id="quizArea" class="space-y-5"></div>

    <!-- bottom submit -->
    <div class="sticky-submit mt-4">
      <button id="btnSubmitBottom" class="btn btn-primary w-full">Nộp bài</button>
      <div class="small mt-2">* Chỉ hiển thị kết quả sau khi nộp. Reload trang sẽ giữ lại tiến độ (không lộ đáp án).</div>
    </div>

    <!-- RESULT STRIP -->
    <div id="resultStrip" class="hidden mt-4">
      <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
        <div class="p-3 bg-white rounded shadow text-center">
          <div class="text-sm text-gray-500">Điểm</div><div id="scoreBig" class="text-3xl font-extrabold"></div>
        </div>
        <div class="p-3 bg-white rounded shadow text-center">
          <div class="text-sm text-gray-500">Đúng</div><div id="numCorrect" class="text-2xl font-semibold text-green-600">0</div>
        </div>
        <div class="p-3 bg-white rounded shadow text-center">
          <div class="text-sm text-gray-500">Sai</div><div id="numWrong" class="text-2xl font-semibold text-rose-600">0</div>
        </div>
        <div class="p-3 bg-white rounded shadow text-center">
          <div class="text-sm text-gray-500">Chưa chọn</div><div id="numBlank" class="text-2xl font-semibold text-gray-600">0</div>
        </div>
      </div>
    </div>

    <!-- RANK AREA -->
    <div id="rankArea" class="hidden mt-4"></div>

    <!-- ADMIN AREA -->
    <div id="adminArea" class="hidden mt-4">
      <div class="flex gap-2 items-center mb-3">
        <input id="inpAdminSecret" class="px-3 py-2 border rounded w-72" placeholder="Admin secret">
        <button id="btnAdminLoad" class="btn btn-ghost">Tải submissions</button>
        <input id="inpDelName" class="px-3 py-2 border rounded" placeholder="Tên cần xoá khỏi BXH">
        <button id="btnAdminDel" class="btn btn-primary">Xoá tên</button>
      </div>
      <div id="adminList" class="space-y-2"></div>
    </div>

    <div class="text-right text-xs text-gray-400 mt-4">© <span id="yy"></span> Trường Thịnh</div>
  </div>
</div>

<script>
document.getElementById('yy').textContent = new Date().getFullYear();

/* ====== CẤU HÌNH KẾT NỐI API ====== */
const API_URL = "https://6dbbe512e523c0.lhr.life"; // <== nếu tunnel đổi, sửa dòng này
const ADMIN_SECRET_HINT = "trthinhdeptrai09";   // chỉ gợi ý, không bắt buộc khớp

/* ====== CẤU HÌNH ĐỀ & THỜI GIAN ====== */
const EXAM_MINUTES = 20;
const STORAGE_KEY = "exercise3_33_state_v3";

/* ====== CÂU HỎI (33 câu) ====== */
const QUESTIONS_SOURCE = [
  {id:"ex3-1", prompt:"Parents should share household ______ so that no one feels overloaded.", options:["jobs","work","chores","duties"], answer:2},
  {id:"ex3-2", prompt:"We should use public transport more often to help protect the ______.", options:["nature","air","planet","environment"], answer:3},
  {id:"ex3-3", prompt:"We should recycle plastic bottles instead of throwing them into the ______.", options:["bin","land","park","rubbish"], answer:0},
  {id:"ex3-4", prompt:"Families with strong ______ usually have better communication and understanding.", options:["rules","values","bonds","chores"], answer:2},
  {id:"ex3-5", prompt:"Teenagers should learn to be more ______ by doing simple household tasks.", options:["careful","hardworking","responsible","patient"], answer:2},
  {id:"ex3-6", prompt:"Turning off lights helps us save both energy and ______.", options:["electricity","environment","money","carbon"], answer:2},
  {id:"ex3-7", prompt:"Taylor Swift’s latest ______ has topped the music charts for weeks.", options:["song","playlist","album","rhythm"], answer:2},
  {id:"ex3-8", prompt:"The orchestra will ______ a concert at the city theatre next month.", options:["compose","perform","produce","direct"], answer:1},
  {id:"ex3-9", prompt:"My father often ______ the heavy lifting in our family.", options:["do","does","is doing","has done"], answer:1},
  {id:"ex3-10", prompt:"We usually ______ turns to cook dinner.", options:["take","taking","are taking","took"], answer:0},
  {id:"ex3-11", prompt:"He ______ the garbage every morning before going to work.", options:["takes out","is taking out","took out","has taken out"], answer:0},
  {id:"ex3-12", prompt:"Look! The children ______ the living room.", options:["clean","are cleaning","cleans","cleaned"], answer:1},
  {id:"ex3-13", prompt:"My mother ______ the laundry on Sundays.", options:["does","doing","did","has done"], answer:0},
  {id:"ex3-14", prompt:"Helping with household chores ______ children become more responsible.", options:["make","made","makes","is making"], answer:2},
  {id:"ex3-15", prompt:"Listen! The band ______ a new song on stage.", options:["play","plays","are playing","have played"], answer:2},
  {id:"ex3-16", prompt:"I think the new song ______ a big hit.", options:["will be","is being","is going to be","be"], answer:0},
  {id:"ex3-17", prompt:"People ______ use electric cars more in the future.", options:["are going to","will","uses","used"], answer:1},
  {id:"ex3-18", prompt:"They ______ a concert next weekend to raise money for charity.", options:["hold","will holding","are going to hold","holding"], answer:2},
  {id:"ex3-19", prompt:"New recycling machines ______ in the city next month.", options:["are installed","were installed","will install","will be installed"], answer:3},
  {id:"ex3-20", prompt:"Trees ______ every year to make the city greener.", options:["plant","are planted","were planted","will plant"], answer:1},
  {id:"ex3-21", prompt:"Plastic bottles ______ into new products in many factories.", options:["recycle","are recycled","were recycled","will recycle"], answer:1},
  {id:"ex3-22", prompt:"Solar energy ______ by many countries in the future.", options:["will use","will be used","is used","was used"], answer:1},
  {id:"ex3-23", prompt:"The singer is talented, ____ she needs more experience on stage.", options:["and","so","but","for"], answer:2},
  {id:"ex3-24", prompt:"She plays the guitar beautifully, ____ she can also compose songs.", options:["but","and","or","yet"], answer:1},
  {id:"ex3-25", prompt:"Tom practices the piano every day, ____ he still finds it hard to perform.", options:["so","for","yet","or"], answer:2},
  {id:"ex3-26", prompt:"The concert was canceled, ____ the fans were very disappointed.", options:["but","so","or","yet"], answer:1},
  {id:"ex3-27", prompt:"You can download the song for free ____ buy the full album online.", options:["and","but","or","yet"], answer:2},
  {id:"ex3-28", prompt:"She decided _______ a new piano for her music class.", options:["buy","buying","to buy","bought"], answer:2},
  {id:"ex3-29", prompt:"We heard the band _______ their new song at the concert.", options:["to perform","performing","perform","performed"], answer:2},
  {id:"ex3-30", prompt:"The music club plans _______ a charity concert next month.", options:["organizing","to organize","organize","to be organized"], answer:1},
  {id:"ex3-31", prompt:"The students were happy _______ the music competition.", options:["join","to join","joining","joined"], answer:1},
  {id:"ex3-32", prompt:"Let the choir _______ their song before we leave.", options:["to finish","finish","finished","finishing"], answer:1},
  {id:"ex3-33", prompt:"She promised _______ her voice for the school concert.", options:["using","use","to use","used"], answer:2}
];

/* ====== UTIL ====== */
const $ = sel => document.querySelector(sel);
const $c = (el,cls,txt) => { const d=document.createElement(el); if(cls) d.className=cls; if(txt!=null) d.textContent=txt; return d; };
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function formatMMSS(s){ s=Math.max(0, s|0); return String(s/60|0).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function restore(){ try{const s=localStorage.getItem(STORAGE_KEY); return s?JSON.parse(s):null;}catch{return null;} }

/* ====== STATE ====== */
let state=null, timer=null;

/* ====== BUILD NEW ATTEMPT ====== */
function buildNewAttempt(){
  const working = QUESTIONS_SOURCE.map(q=>({...q,options:[...q.options]}));
  shuffle(working);
  working.forEach(q=>{
    const pairs=q.options.map((opt,idx)=>({opt,idx}));
    shuffle(pairs);
    q._order=pairs.map(p=>p.idx);   // idx hiển thị -> idx gốc
    q._opts =pairs.map(p=>p.opt);
  });
  return {name:"", working, answers:{}, remainSec:EXAM_MINUTES*60, submitted:false};
}

/* ====== RENDER QUIZ ====== */
const quizArea = $('#quizArea');
function renderQuiz(markAfterSubmit=false){
  quizArea.innerHTML='';
  state.working.forEach((q,i)=>{
    const card=$c('div','p-3 bg-white rounded-lg border fade');
    const head=$c('div','flex items-start justify-between mb-2');
    head.appendChild($c('div','font-medium',`Câu ${i+1}. ${q.prompt}`));

    const badge=$c('span','badge hidden'); head.appendChild(badge);
    card.appendChild(head);

    const grid=$c('div','grid sm:grid-cols-2 gap-2');
    q._opts.forEach((txt,idx)=>{
      const btn=$c('button','choice w-full text-left px-3 py-2 rounded border bg-gray-50');
      btn.innerHTML=`<b class="pr-2">${String.fromCharCode(65+idx)}.</b> ${txt}`;
      if(state.answers[q.id]===idx) btn.classList.add('selected','ring-1','ring-indigo-500');

      btn.addEventListener('click',()=>{
        if(state.submitted) return; // không cho đổi sau khi nộp
        state.answers[q.id]=idx;
        [...grid.children].forEach(c=>c.classList.remove('selected','ring-1','ring-indigo-500'));
        btn.classList.add('selected','ring-1','ring-indigo-500');
        persist();
      });
      grid.appendChild(btn);
    });
    card.appendChild(grid);

    if(markAfterSubmit){
      const chosen=state.answers[q.id];
      const correctIdxLocal = q._order.indexOf(q.answer); // vị trí đúng theo thứ tự đã xáo
      [...grid.children].forEach((b,k)=>{
        if(k===correctIdxLocal) b.classList.add('correct');
      });
      if(typeof chosen==='number'){
        if(chosen!==correctIdxLocal){
          grid.children[chosen].classList.add('wrong');
          badge.className='badge bg-rose-100 text-rose-700'; badge.textContent='Sai'; badge.classList.remove('hidden');
        }else{
          badge.className='badge bg-green-100 text-green-700'; badge.textContent='Đúng'; badge.classList.remove('hidden');
        }
      }else{
        badge.className='badge bg-gray-100 text-gray-700'; badge.textContent='Chưa chọn'; badge.classList.remove('hidden');
      }
    }
    quizArea.appendChild(card);
  });
}

/* ====== GRADE & RESULT ====== */
const scoreBig=$('#scoreBig'), numCorrect=$('#numCorrect'), numWrong=$('#numWrong'), numBlank=$('#numBlank');
function grade(){
  let total=state.working.length, correct=0, blank=0;
  state.working.forEach(q=>{
    const chosen=state.answers[q.id];
    if(typeof chosen!=='number'){ blank++; return; }
    const originalIdx = q._order[chosen];
    if(Number(originalIdx)===Number(q.answer)) correct++;
  });
  const wrong = total - correct - blank;
  const percent = total? Math.round(100*correct/total) : 0;
  return {total,correct,wrong,blank,percent};
}
function showResultStrip(r){
  $('#resultStrip').classList.remove('hidden');
  scoreBig.textContent = r.percent + '%';
  numCorrect.textContent = r.correct;
  numWrong.textContent = r.wrong;
  numBlank.textContent = r.blank;
}

/* ====== TIMER/PROGRESS ====== */
const progressEl=$('#progress'), clockEl=$('#clock');
function startTimer(){
  stopTimer();
  timer=setInterval(()=>{
    if(state.submitted) return;
    state.remainSec--; updateClock(); persist();
    if(state.remainSec<=0){ stopTimer(); handleSubmit(); }
  },1000);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function updateClock(){
  const left=Math.max(0,state.remainSec|0);
  clockEl.textContent=formatMMSS(left);
  const used=(EXAM_MINUTES*60-left);
  progressEl.style.width=(Math.max(0,Math.min(1,used/(EXAM_MINUTES*60)))*100).toFixed(1)+'%';
}

/* ====== API ====== */
async function apiGet(path){ const r=await fetch(API_URL+path); return r.json(); }
async function apiPost(path,body){ const r=await fetch(API_URL+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); return r.json(); }

/* ====== PREVENT DUP NAME (best-effort) ====== */
async function isNameTaken(name){
  try{
    const lb=await apiGet('/api/leaderboard');
    const list=(lb.data||[]).map(x=>x.name?.trim().toLowerCase());
    return list.includes(String(name).trim().toLowerCase());
  }catch{ return false; }
}

/* ====== SUBMIT ====== */
async function handleSubmit(){
  if(state.submitted) return;
  const name=$('#inpName').value.trim();
  if(!name){ $('#nameWarn').classList.remove('hidden'); return; }
  // cảnh báo trùng tên (server vẫn chặn ở backend)
  if(await isNameTaken(name)){ $('#nameWarn').textContent='* Tên đã có trên BXH, chọn tên khác'; $('#nameWarn').classList.remove('hidden'); return; }
  $('#nameWarn').classList.add('hidden');

  state.name=name;
  const r=grade();
  state.submitted=true; persist(); stopTimer();

  // render đánh dấu đúng/sai ngay trên bài làm
  renderQuiz(true);
  showResultStrip(r);

  // gửi lên server (không chặn UI nếu lỗi)
  try{
    await apiPost('/api/submit', {
      name: state.name, score: r.percent, correct: r.correct, wrong: r.wrong,
      blank: r.blank, total: r.total, timeLeft: state.remainSec|0
    });
  }catch(e){ console.warn('submit error',e); }

  // tải BXH cập nhật
  loadLeaderboard();
}

/* ====== RESET/LÀM LẠI ====== */
function doReset(){
  if(!confirm('Làm lại bài? Câu & đáp án sẽ xáo trộn.')) return;
  state=buildNewAttempt();
  $('#inpName').value=state.name;
  $('#resultStrip').classList.add('hidden');
  renderQuiz(false); updateClock(); startTimer();
  persist();
}

/* ====== RANKING ====== */
const rankArea=$('#rankArea');
async function loadLeaderboard(){
  rankArea.innerHTML='<div class="small text-gray-500">Đang tải BXH…</div>';
  try{
    const r=await apiGet('/api/leaderboard');
    const rows=(r.data||[]);
    const wrap=$c('div','overflow-x-auto');
    const table=document.createElement('table');
    table.className='min-w-full text-sm';
    table.innerHTML=`<thead><tr class="text-left text-gray-500">
      <th class="py-2 pr-3">#</th><th class="py-2 pr-3">Tên</th><th class="py-2 pr-3">Điểm</th>
      <th class="py-2 pr-3">Đúng/Sai/Trống</th><th class="py-2 pr-3">Thời gian còn</th><th class="py-2 pr-3">Lần gửi</th>
    </tr></thead><tbody></tbody>`;
    const tb=table.querySelector('tbody');
    rows.forEach((e,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="py-2 pr-3">${i+1}</td>
        <td class="py-2 pr-3 font-medium">${e.name||''}</td>
        <td class="py-2 pr-3 font-semibold">${e.score||0}%</td>
        <td class="py-2 pr-3">${e.correct||0}/${e.wrong||0}/${e.blank||0}</td>
        <td class="py-2 pr-3">${formatMMSS(e.timeLeft||0)}</td>
        <td class="py-2 pr-3 small text-gray-500">${new Date(e.ts||Date.now()).toLocaleString()}</td>`;
      tb.appendChild(tr);
    });
    wrap.appendChild(table);
    rankArea.innerHTML='';
    rankArea.appendChild(wrap);
  }catch(e){
    rankArea.innerHTML='<div class="text-rose-600 text-sm">Không tải được BXH.</div>';
  }
}

/* ====== ADMIN ====== */
const adminArea=$('#adminArea'), adminList=$('#adminList');
$('#btnAdminLoad').addEventListener('click', async ()=>{
  const sec=$('#inpAdminSecret').value.trim();
  adminList.innerHTML='<div class="small text-gray-500">Đang tải…</div>';
  try{
    const r=await fetch(API_URL+'/api/admin/submissions?secret='+encodeURIComponent(sec)).then(r=>r.json());
    const data=r.data||[];
    adminList.innerHTML='';
    data.forEach((e)=>{
      const card=$c('div','p-3 border rounded');
      card.innerHTML=`<div class="font-medium">${e.name||'(no name)'} <span class="small text-gray-500">${new Date(e.ts).toLocaleString()}</span></div>
      <div class="small">Điểm: <b>${e.score}%</b> — ${e.correct}/${e.wrong}/${e.blank} — còn ${formatMMSS(e.timeLeft||0)}</div>`;
      adminList.appendChild(card);
    });
  }catch(err){
    adminList.innerHTML='<div class="text-rose-600 text-sm">Lỗi hoặc sai secret.</div>';
  }
});
$('#btnAdminDel').addEventListener('click', async ()=>{
  const sec=$('#inpAdminSecret').value.trim();
  const name=$('#inpDelName').value.trim();
  if(!name) return alert('Nhập tên cần xoá.');
  try{
    await fetch(API_URL+'/api/admin/remove-name',{method:'POST',headers:{'Content-Type':'application/json','x-admin-secret':sec},body:JSON.stringify({name})});
    alert('Đã xoá.'); loadLeaderboard();
  }catch{ alert('Xoá lỗi.'); }
});

/* ====== TABS ====== */
function showTab(t){
  const T={quiz:$('#tabQuiz'), rank:$('#tabRank'), admin:$('#tabAdmin')};
  Object.values(T).forEach(el=>el.classList.remove('tab-active'));
  if(t==='quiz'){ T.quiz.classList.add('tab-active'); $('#rankArea').classList.add('hidden'); adminArea.classList.add('hidden'); $('#resultStrip').classList.toggle('hidden',!state.submitted); quizArea.classList.remove('hidden'); }
  if(t==='rank'){ T.rank.classList.add('tab-active'); quizArea.classList.add('hidden'); adminArea.classList.add('hidden'); $('#resultStrip').classList.add('hidden'); $('#rankArea').classList.remove('hidden'); loadLeaderboard(); }
  if(t==='admin'){ T.admin.classList.add('tab-active'); quizArea.classList.add('hidden'); $('#rankArea').classList.add('hidden'); $('#resultStrip').classList.add('hidden'); adminArea.classList.remove('hidden'); if(!$('#inpAdminSecret').value) $('#inpAdminSecret').value = ADMIN_SECRET_HINT; }
}
$('#tabQuiz').addEventListener('click',()=>showTab('quiz'));
$('#tabRank').addEventListener('click',()=>showTab('rank'));
$('#tabAdmin').addEventListener('click',()=>showTab('admin'));

/* ====== INIT ====== */
$('#btnSubmitTop').addEventListener('click',handleSubmit);
$('#btnSubmitBottom').addEventListener('click',handleSubmit);
$('#btnResetAll').addEventListener('click',doReset);

(function init(){
  const restored=restore();
  if(restored && restored.working && !restored.submitted && restored.remainSec>0){ state=restored; }
  else{ state=buildNewAttempt(); }
  $('#inpName').value=state.name||'';
  renderQuiz(false); updateClock(); if(!state.submitted) startTimer(); else { renderQuiz(true); showResultStrip(grade()); }
})();
</script>
</body>
</html>
