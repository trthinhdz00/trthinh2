<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Thi/Luyện tập – Trường Thịnh</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<style>
:root{ --accent:#6366f1 }
body{ background:linear-gradient(135deg,#f8fafc,#ffffff); font-family:Inter,system-ui,Segoe UI,-apple-system }
.card{ background:rgba(255,255,255,.85); backdrop-filter:blur(8px); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(15,23,42,.08) }
.tab{ padding:8px 14px; border-radius:10px; cursor:pointer; user-select:none }
.tab-active{ background:var(--accent); color:#fff }
.choice{ transition:transform .12s, box-shadow .12s }
.choice:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(99,102,241,.12) }
.btn{ padding:.6rem 1rem; border-radius:.75rem }
.btn-ghost{ background:#f3f4f6 }
.btn-primary{ background:var(--accent); color:#fff }
.progress-wrap{ height:8px; background:#eef2ff; border-radius:999px; overflow:hidden }
.progress{ height:100%; background:var(--accent); width:0% }
.badge{ font-size:.75rem; padding:.2rem .5rem; border-radius:999px }
.fade{ animation:fade .28s ease-out both } @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
</style>
</head>
<body class="min-h-screen flex items-start justify-center py-8">
<div class="w-full max-w-4xl px-4">
  <header class="mb-4 text-center">
    <h1 class="text-2xl font-extrabold">Thi/Luyện tập – <span style="color:var(--accent)">Trường Thịnh</span></h1>
    <p class="text-sm text-gray-500">Hoàn thành bài rồi bấm <b>Nộp bài</b> để xem điểm. Mỗi lần <b>Làm lại</b> sẽ xáo trộn thứ tự câu hỏi & đáp án.</p>
  </header>

  <div class="card space-y-4 fade">
    <!-- Top controls -->
    <div class="flex gap-2 items-center">
      <div id="tabQuiz" class="tab tab-active">Làm bài</div>
      <div id="tabResult" class="tab">Kết quả</div>

      <div class="ml-auto flex items-center gap-2">
        <div class="hidden sm:flex items-center gap-2 text-sm text-gray-600">
          <span>Thời gian:</span>
          <span id="clock" class="font-semibold text-gray-800">20:00</span>
        </div>
        <button id="btnResetAll" class="btn btn-ghost">Làm lại</button>
        <button id="btnSubmit" class="btn btn-primary">Nộp bài</button>
      </div>
    </div>

    <!-- Timer bar -->
    <div class="progress-wrap">
      <div id="progress" class="progress"></div>
    </div>

    <!-- Quiz area -->
    <div id="quizArea" class="space-y-3"></div>

    <!-- Result area -->
    <div id="resultArea" class="hidden">
      <div class="text-center py-6">
        <div id="scoreBig" class="text-4xl font-extrabold text-gray-800"></div>
        <div id="scoreSmall" class="text-sm text-gray-600 mt-2"></div>
        <div class="mt-4 flex justify-center gap-4">
          <div class="p-3 bg-white rounded shadow text-center">
            <div class="text-sm text-gray-500">Đúng</div>
            <div id="numCorrect" class="text-xl font-semibold text-green-600">0</div>
          </div>
          <div class="p-3 bg-white rounded shadow text-center">
            <div class="text-sm text-gray-500">Sai</div>
            <div id="numWrong" class="text-xl font-semibold text-rose-600">0</div>
          </div>
          <div class="p-3 bg-white rounded shadow text-center">
            <div class="text-sm text-gray-500">Chưa chọn</div>
            <div id="numBlank" class="text-xl font-semibold text-gray-600">0</div>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-3">Kết quả chỉ hiển thị sau khi bạn bấm <b>Nộp bài</b> hoặc khi hết thời gian.</p>
      </div>
    </div>

    <div class="text-right text-xs text-gray-400">© <span id="yy"></span> Trường Thịnh</div>
  </div>
</div>

<script>
document.getElementById('yy').textContent = new Date().getFullYear();

/* ====================== CẤU HÌNH ====================== */
// Thời gian thi (phút):
const EXAM_MINUTES = 20;  // theo yêu cầu: 20p

// DỮ LIỆU CÂU HỎI (30 câu). Bạn có thể sửa, thêm/bớt ở đây.
// Mỗi câu: { id, prompt, options[4], answer }  (answer = chỉ số đáp án đúng theo options gốc)
const QUESTIONS_SOURCE = [
  {id:"q1", prompt:"Chọn từ đúng điền vào chỗ trống: Parents should share household ______ so that no one feels overloaded.", options:["jobs","work","chores","duties"], answer:2},
  {id:"q2", prompt:"We should use public transport more often to help protect the ______.", options:["nature","air","planet","environment"], answer:3},
  {id:"q3", prompt:"Recycle plastic bottles instead of throwing them into the ______.", options:["bin","land","park","rubbish"], answer:0},
  {id:"q4", prompt:"Families with strong ______ usually have better communication.", options:["rules","values","bonds","chores"], answer:2},
  {id:"q5", prompt:"Teenagers should learn to be more ______ by doing simple household tasks.", options:["careful","hardworking","responsible","patient"], answer:2},
  {id:"q6", prompt:"Turning off lights helps us save both energy and ______.", options:["electricity","environment","money","carbon"], answer:2},
  {id:"q7", prompt:"Taylor Swift’s latest ______ has topped the music charts for weeks.", options:["song","playlist","album","rhythm"], answer:2},
  {id:"q8", prompt:"The orchestra will ______ a concert next month.", options:["compose","perform","produce","direct"], answer:1},
  {id:"q9", prompt:"My father often ______ the heavy lifting in our family.", options:["do","does","is doing","has done"], answer:1},
  {id:"q10", prompt:"We usually ______ turns to cook dinner.", options:["take","taking","are taking","took"], answer:0},
  {id:"q11", prompt:"He ______ the garbage every morning before work.", options:["takes out","is taking out","took out","has taken out"], answer:0},
  {id:"q12", prompt:"Look! The children ______ the living room.", options:["clean","are cleaning","cleans","cleaned"], answer:1},
  {id:"q13", prompt:"My mother ______ the laundry on Sundays.", options:["does","doing","did","has done"], answer:0},
  {id:"q14", prompt:"Helping with household chores ______ children become more responsible.", options:["make","made","makes","is making"], answer:2},
  {id:"q15", prompt:"Listen! The band ______ a new song on stage.", options:["play","plays","are playing","have played"], answer:2},
  {id:"q16", prompt:"I think the new song ______ a big hit.", options:["will be","is being","is going to be","be"], answer:0},
  {id:"q17", prompt:"People ______ use electric cars more in the future.", options:["are going to","will","uses","used"], answer:1},
  {id:"q18", prompt:"They ______ a concert next weekend to raise money for charity.", options:["hold","will holding","are going to hold","holding"], answer:2},
  {id:"q19", prompt:"New recycling machines ______ in the city next month.", options:["are installed","were installed","will install","will be installed"], answer:3},
  {id:"q20", prompt:"Trees ______ every year to make the city greener.", options:["plant","are planted","were planted","will plant"], answer:1},
  {id:"q21", prompt:"Plastic bottles ______ into new products in many factories.", options:["recycle","are recycled","were recycled","will recycle"], answer:1},
  {id:"q22", prompt:"Solar energy ______ by many countries in the future.", options:["will use","will be used","is used","was used"], answer:1},
  {id:"q23", prompt:"The singer is talented, ____ she needs more experience on stage.", options:["and","so","but","for"], answer:2},
  {id:"q24", prompt:"She plays the guitar beautifully, ____ she can also compose songs.", options:["but","and","or","yet"], answer:1},
  {id:"q25", prompt:"Tom practices the piano every day, ____ he still finds it hard to perform.", options:["so","for","yet","or"], answer:2},
  {id:"q26", prompt:"The concert was canceled, ____ the fans were very disappointed.", options:["but","so","or","yet"], answer:1},
  {id:"q27", prompt:"You can download the song for free ____ buy the full album online.", options:["and","but","or","yet"], answer:2},
  {id:"q28", prompt:"She decided _______ a new piano for her music class.", options:["buy","buying","to buy","bought"], answer:2},
  {id:"q29", prompt:"We heard the band _______ their new song at the concert.", options:["to perform","performing","perform","performed"], answer:2},
  {id:"q30", prompt:"The music club plans _______ a charity concert next month.", options:["organizing","to organize","organize","to be organized"], answer:1},
];

/* ====================== LOGIC ====================== */
const tabQuiz = document.getElementById('tabQuiz');
const tabResult = document.getElementById('tabResult');
const quizArea = document.getElementById('quizArea');
const resultArea = document.getElementById('resultArea');
const btnSubmit = document.getElementById('btnSubmit');
const btnResetAll = document.getElementById('btnResetAll');
const clockEl = document.getElementById('clock');
const progressEl = document.getElementById('progress');
const scoreBig = document.getElementById('scoreBig');
const scoreSmall = document.getElementById('scoreSmall');
const numCorrect = document.getElementById('numCorrect');
const numWrong = document.getElementById('numWrong');
const numBlank = document.getElementById('numBlank');

let working = [];          // câu hỏi đã shuffle (cả thứ tự câu lẫn vị trí đáp án)
let answers = {};          // answers[q.id] = index đáp án được chọn (theo vị trí sau khi xáo)
let timer = null;
let remainSec = EXAM_MINUTES * 60;
let submitted = false;

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr }
function formatMMSS(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const sec=(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }

function prepareAttempt(){
  // Clone & shuffle câu hỏi
  working = QUESTIONS_SOURCE.map(q => ({...q, options:[...q.options]}));
  shuffle(working); // xáo thứ tự câu hỏi

  // Với mỗi câu hỏi: xáo trộn vị trí đáp án, đồng thời lưu mapping về index gốc
  working.forEach(q => {
    const pairs = q.options.map((opt, idx) => ({opt, idx}));
    shuffle(pairs);
    q._order = pairs.map(p => p.idx);      // từ vị trí hiển thị -> index gốc
    q._opts = pairs.map(p => p.opt);       // danh sách option sau khi xáo
  });

  answers = {};
  submitted = false;
  quizArea.innerHTML = '';

  // Render
  working.forEach((q, i) => {
    const card = document.createElement('div');
    card.className = 'p-3 bg-white rounded-lg border fade';

    const title = document.createElement('div');
    title.className = 'font-medium mb-2';
    title.textContent = `Câu ${i+1}. ${q.prompt}`;
    card.appendChild(title);

    const grid = document.createElement('div');
    grid.className = 'grid sm:grid-cols-2 gap-2';
    q._opts.forEach((txt, idx) => {
      const btn = document.createElement('button');
      btn.className = 'choice w-full text-left px-3 py-2 rounded border bg-gray-50';
      btn.innerHTML = `<b class="pr-2">${String.fromCharCode(65+idx)}.</b> ${txt}`;
      btn.addEventListener('click', () => {
        answers[q.id] = idx;
        [...grid.children].forEach(c => c.classList.remove('ring-1','ring-indigo-500'));
        btn.classList.add('ring-1','ring-indigo-500');
      });
      grid.appendChild(btn);
    });
    card.appendChild(grid);
    quizArea.appendChild(card);
  });

  // Reset UI
  showTab('quiz');
  resultArea.classList.add('hidden');
  // Timer
  stopTimer();
  remainSec = EXAM_MINUTES * 60;
  updateClock();
  startTimer();
}

function grade(){
  let total = working.length, correct=0, blank=0;
  working.forEach(q => {
    const chosen = answers[q.id];
    if (typeof chosen !== 'number'){ blank++; return; }
    const originalIndex = q._order[chosen]; // map về index gốc
    if (Number(originalIndex) === Number(q.answer)) correct++;
  });
  const wrong = total - correct - blank;
  const percent = total ? Math.round(100 * correct / total) : 0;
  return {total, correct, wrong, blank, percent};
}

function showResult(){
  const r = grade();
  scoreBig.textContent = `${r.percent}%`;
  scoreSmall.textContent = `${r.correct}/${r.total} câu đúng`;
  numCorrect.textContent = r.correct;
  numWrong.textContent = r.wrong;
  numBlank.textContent = r.blank;
  resultArea.classList.remove('hidden');
  showTab('result');
}

function startTimer(){
  timer = setInterval(() => {
    remainSec--;
    updateClock();
    if (remainSec <= 0){
      stopTimer();
      if (!submitted){
        submitted = true;
        showResult(); // tự nộp khi hết giờ
      }
    }
  }, 1000);
}
function stopTimer(){ if (timer){ clearInterval(timer); timer = null; } }
function updateClock(){
  clockEl.textContent = formatMMSS(remainSec);
  const used = (EXAM_MINUTES*60 - remainSec);
  const ratio = Math.max(0, Math.min(1, used / (EXAM_MINUTES*60)));
  progressEl.style.width = (ratio*100).toFixed(1) + '%';
}

function showTab(t){
  if (t === 'quiz'){
    tabQuiz.classList.add('tab-active');
    tabResult.classList.remove('tab-active');
    quizArea.classList.remove('hidden');
    resultArea.classList.add('hidden');
  } else {
    tabResult.classList.add('tab-active');
    tabQuiz.classList.remove('tab-active');
    quizArea.classList.add('hidden');
    resultArea.classList.remove('hidden');
  }
}

// Events
tabQuiz.addEventListener('click', () => showTab('quiz'));
tabResult.addEventListener('click', () => showTab('result'));
btnSubmit.addEventListener('click', () => {
  if (submitted) return showResult();
  submitted = true;
  stopTimer();
  showResult();
});
btnResetAll.addEventListener('click', () => {
  if (!confirm('Làm lại bài? Thứ tự câu hỏi & đáp án sẽ được xáo trộn.')) return;
  prepareAttempt();
});

// Ngăn bấm back/refresh mất bài vô ý (nhẹ nhàng)
window.addEventListener('beforeunload', (e) => {
  if (!submitted){ e.preventDefault(); e.returnValue = ''; }
});

// Bắt đầu
prepareAttempt();
</script>
</body>
</html>      {id:"cr2-1", type:"mcq", prompt:"(Children Helping with Chores) 1)", options:["when it comes to starting with","when it comes to start with","when it come to starting","when it comes starting with"], answer:0},
      {id:"cr2-2", type:"mcq", prompt:"(Children Helping with Chores) 2)", options:["Firstly, that help them understand responsibilities","Firstly, this helps them understand responsibilities","Firstly, helps them understand responsibilities","Firstly, it help them understand responsibilities"], answer:1},
      {id:"cr2-3", type:"mcq", prompt:"(Children Helping with Chores) 3)", options:["strengthen","strengthens","strengthening","strengthened"], answer:1},
      {id:"cr2-4", type:"mcq", prompt:"(Children Helping with Chores) 4)", options:["making","to make","make","makes"], answer:0},
      {id:"cr2-5", type:"mcq", prompt:"(Children Helping with Chores) 5)", options:["where","which","that","when"], answer:0},
      {id:"cr2-6", type:"mcq", prompt:"(Children Helping with Chores) 6)", options:["each other’s time","each other’s help","each other’s support","each other’s work"], answer:2}
    ]
  },
  {
    title: "Cloze Test – Family / Environment / Music",
    items: [
      // Family Life
      {id:"cz-1", type:"mcq", prompt:"(Family Life) 1)", options:["hold","maintain","achieve","manage"], answer:2},
      {id:"cz-2", type:"mcq", prompt:"(Family Life) 2)", options:["lack","lose","miss","forget"], answer:0},
      {id:"cz-3", type:"mcq", prompt:"(Family Life) 3)", options:["reduce","improve","divide","express"], answer:1},
      {id:"cz-4", type:"mcq", prompt:"(Family Life) 4)", options:["pleasant","selfish","quiet","stressful"], answer:0},
      {id:"cz-5", type:"mcq", prompt:"(Family Life) 5)", options:["separate","safe","united","busy"], answer:2},
      // Environment
      {id:"cz-6", type:"mcq", prompt:"(Environment) 6)", options:["change","damage","effect","difference"], answer:0},
      {id:"cz-7", type:"mcq", prompt:"(Environment) 7)", options:["choice","impact","effort","difference"], answer:3},
      {id:"cz-8", type:"mcq", prompt:"(Environment) 8)", options:["importance","pressure","problem","direction"], answer:0},
      {id:"cz-9", type:"mcq", prompt:"(Environment) 9)", options:["pollution","destruction","challenge","condition"], answer:1},
      {id:"cz-10", type:"mcq", prompt:"(Environment) 10)", options:["opportunity","advantage","responsibility","invitation"], answer:2},
      // Music
      {id:"cz-11", type:"mcq", prompt:"(Music) 11)", options:["release","recover","remove","respond"], answer:0},
      {id:"cz-12", type:"mcq", prompt:"(Music) 12)", options:["ability","attention","creativity","discipline"], answer:3},
      {id:"cz-13", type:"mcq", prompt:"(Music) 13)", options:["download","access","record","perform"], answer:1},
      {id:"cz-14", type:"mcq", prompt:"(Music) 14)", options:["importance","popularity","influence","meaning"], answer:0},
      {id:"cz-15", type:"mcq", prompt:"(Music) 15)", options:["separate","divide","connect","distract"], answer:2}
    ]
  },
  {
    title: "Tự luận – Chuyển câu Bị động (Passive Voice)",
    items: [
      {id:"pv-1", type:"essay", prompt:"Pollution affects the environment in many ways.  → (Passive)"},
      {id:"pv-2", type:"essay", prompt:"Americans use around 100 billion plastic bags each year.  → (Passive)"},
      {id:"pv-3", type:"essay", prompt:"People will build this building next year.  → (Passive)"},
      {id:"pv-4", type:"essay", prompt:"The club’s activities will raise people’s awareness of environmental issues.  → (Passive)"},
      {id:"pv-5", type:"essay", prompt:"My mother is going to sell this house.  → (Passive)"},
      {id:"pv-6", type:"essay", prompt:"The students are going to plant trees here.  → (Passive)"},
      {id:"pv-7", type:"essay", prompt:"They are building a new music school in the city.  → (Passive)"},
      {id:"pv-8", type:"essay", prompt:"The students are cleaning the school playground this morning.  → (Passive)"},
      {id:"pv-9", type:"essay", prompt:"(Lặp) People will build this building next year.  → (Passive)"},
      {id:"pv-10", type:"essay", prompt:"(Lặp) Americans use around 100 billion plastic bags each year.  → (Passive)"}
    ],
    // Model answers to show when chấm
    solutions: {
      "pv-1":"The environment is affected in many ways (by pollution).",
      "pv-2":"Around 100 billion plastic bags are used each year (by Americans).",
      "pv-3":"This building will be built next year.",
      "pv-4":"People’s awareness of environmental issues will be raised by the club’s activities.",
      "pv-5":"This house is going to be sold (by my mother).",
      "pv-6":"Trees are going to be planted here (by the students).",
      "pv-7":"A new music school is being built in the city.",
      "pv-8":"The school playground is being cleaned this morning (by the students).",
      "pv-9":"This building will be built next year.",
      "pv-10":"Around 100 billion plastic bags are used each year (by Americans)."
    }
  },
  {
    title: "Chia thì – Present Simple/Continuous (sửa lỗi)",
    items: [
      {id:"vt-1", type:"essay", prompt:"He always (get up) late every day.  → ________"},
      {id:"vt-2", type:"essay", prompt:"My brother often (play) football in the afternoon.  → ________"},
      {id:"vt-3", type:"essay", prompt:"The students often (go) to school every day.  → ________"},
      {id:"vt-4", type:"essay", prompt:"His father (not drink) coffee every evening.  → ________"},
      {id:"vt-5", type:"essay", prompt:"Mary always (clean) the floor in the morning.  → ________"},
      {id:"vt-6", type:"essay", prompt:"Mr. Black (go) shopping at weekends?  → ________"},
      {id:"vt-7", type:"essay", prompt:"Mrs. Lan usually (do) the cooking in her family.  → ________"},
      {id:"vt-8", type:"essay", prompt:"My parents (have) breakfast in the room now.  → ________"},
      {id:"vt-9", type:"essay", prompt:"His mother (water) the flowers right now.  → ________"},
      {id:"vt-10", type:"essay", prompt:"Don’t make noise! The children (sleep) in the room.  → ________"},
      {id:"vt-11", type:"essay", prompt:"Be quiet! They (discuss) an important problem.  → ________"}
    ],
    solutions: {
      "vt-1":"gets up",
      "vt-2":"plays",
      "vt-3":"go",
      "vt-4":"doesn’t drink",
      "vt-5":"cleans",
      "vt-6":"Does Mr. Black go shopping at weekends?",
      "vt-7":"does",
      "vt-8":"are having",
      "vt-9":"is watering",
      "vt-10":"are sleeping",
      "vt-11":"are discussing"
    }
  }
];

// ============ Render ============
const app = document.getElementById("app");

function persist(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}
function restore(key, fallback) {
  try {
    const s = localStorage.getItem(key);
    return s ? JSON.parse(s) : fallback;
  } catch { return fallback; }
}
const STORE_KEY = "thinh_english_quiz_v1";

let state = restore(STORE_KEY, { answers: {}, essays: {} });

function renderChoice(item, sectionIdx) {
  const saved = state.answers[item.id];
  const wrapper = document.createElement("div");
  wrapper.className = "p-4 bg-white rounded-xl shadow";
  const q = document.createElement("p");
  q.className = "font-medium mb-3";
  q.textContent = item.prompt;
  wrapper.appendChild(q);
  const grid = document.createElement("div");
  grid.className = "grid sm:grid-cols-2 gap-2";
  item.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "choice w-full text-left px-3 py-2 rounded-lg border bg-gray-50 hover:bg-gray-100";
    btn.textContent = String.fromCharCode(65+idx)+". "+opt;
    if (saved === idx) btn.classList.add("ring-1","ring-indigo-500");
    btn.addEventListener("click", () => {
      state.answers[item.id] = idx;
      persist(STORE_KEY, state);
      [...grid.querySelectorAll(".choice")].forEach(c => c.classList.remove("ring-1","ring-indigo-500"));
      btn.classList.add("ring-1","ring-indigo-500");
    });
    grid.appendChild(btn);
  });
  wrapper.appendChild(grid);

  const result = document.createElement("div");
  result.className = "mt-3 text-sm";
  result.id = "res-"+item.id;
  wrapper.appendChild(result);

  const checkBtn = document.createElement("button");
  checkBtn.className = "mt-3 px-3 py-2 bg-blue-600 text-white rounded-lg";
  checkBtn.textContent = "Chấm câu này";
  checkBtn.addEventListener("click", () => gradeItem(item));
  wrapper.appendChild(checkBtn);
  return wrapper;
}

function renderEssay(item, solutions) {
  const wrapper = document.createElement("div");
  wrapper.className = "p-4 bg-white rounded-xl shadow";
  const q = document.createElement("p");
  q.className = "font-medium mb-3";
  q.textContent = item.prompt;
  wrapper.appendChild(q);

  const ta = document.createElement("textarea");
  ta.className = "w-full border rounded-lg p-3 bg-gray-50";
  ta.rows = 2;
  ta.value = state.essays[item.id] || "";
  ta.placeholder = "Viết trả lời...";
  ta.addEventListener("input", () => {
    state.essays[item.id] = ta.value;
    persist(STORE_KEY, state);
  });
  wrapper.appendChild(ta);

  const result = document.createElement("div");
  result.className = "mt-3 text-sm";
  result.id = "res-"+item.id;
  wrapper.appendChild(result);

  const checkBtn = document.createElement("button");
  checkBtn.className = "mt-3 px-3 py-2 bg-blue-600 text-white rounded-lg";
  checkBtn.textContent = "Hiện đáp án mẫu";
  checkBtn.addEventListener("click", () => {
    const ans = (solutions && solutions[item.id]) ? solutions[item.id] : "(chưa có đáp án mẫu)";
    result.innerHTML = `<span class="badge bg-green-100 text-green-700">Gợi ý</span> <span class="ml-2">${escapeHtml(ans)}</span>`;
  });
  wrapper.appendChild(checkBtn);

  return wrapper;
}

function gradeItem(item) {
  const res = document.getElementById("res-"+item.id);
  if (item.type === "mcq") {
    const chosen = state.answers[item.id];
    if (chosen == null) {
      res.innerHTML = `<span class="badge bg-yellow-100 text-yellow-700">Chưa chọn</span> Hãy chọn A/B/C/D.`;
      return;
    }
    const isCorrect = Number(chosen) === Number(item.answer);
    res.innerHTML = (isCorrect
      ? `<span class="badge bg-green-100 text-green-700">Đúng</span> Đáp án: ${String.fromCharCode(65+item.answer)}.`
      : `<span class="badge bg-red-100 text-red-700">Sai</span> Đáp án đúng: ${String.fromCharCode(65+item.answer)}.`)
      + (item.explanation ? ` <span class="text-gray-600">${escapeHtml(item.explanation)}</span>` : "");
  } else {
    res.innerHTML = `<span class="badge bg-indigo-100 text-indigo-700">Đã lưu</span> Nhấn “Hiện đáp án mẫu” để xem lời giải gợi ý.`;
  }
}

function renderAll() {
  app.innerHTML = "";
  QUIZZES.forEach((section, sIdx) => {
    const card = document.createElement("section");
    card.className = "bg-gray-100 rounded-2xl p-4 sm:p-6 border";
    const h2 = document.createElement("h2");
    h2.className = "text-xl font-semibold mb-4";
    h2.textContent = section.title;
    card.appendChild(h2);

    section.items.forEach(item => {
      const el = item.type === "mcq"
        ? renderChoice(item, sIdx)
        : renderEssay(item, section.solutions || {});
      card.appendChild(el);
    });

    app.appendChild(card);
  });
}

function checkAll() {
  QUIZZES.forEach(section => {
    section.items.forEach(gradeItem);
  });
}

function resetAll() {
  if (!confirm("Xoá toàn bộ đáp án và tiến độ?")) return;
  state = { answers: {}, essays: {} };
  persist(STORE_KEY, state);
  renderAll();
}

function exportProgress() {
  const a = document.createElement("a");
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  a.href = URL.createObjectURL(blob);
  a.download = "tien-do-english.json";
  a.click();
}

function importProgress(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data || typeof data !== "object") throw new Error("Bad file");
      state = { answers: data.answers || {}, essays: data.essays || {} };
      persist(STORE_KEY, state);
      renderAll();
      alert("Đã nhập tiến độ!");
    } catch(err) {
      alert("File không hợp lệ.");
    }
  };
  reader.readAsText(file);
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// Bindings
document.getElementById("btnCheckAll").addEventListener("click", checkAll);
document.getElementById("btnReset").addEventListener("click", resetAll);
document.getElementById("btnExport").addEventListener("click", exportProgress);
document.getElementById("btnImport").addEventListener("click", () => document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", (e) => {
  if (e.target.files && e.target.files[0]) importProgress(e.target.files[0]);
});

// Init
renderAll();

</script>
</body>
</html>
